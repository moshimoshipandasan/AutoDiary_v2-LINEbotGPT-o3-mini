# AutoDiary LINEボット

LINEとChatGPTを連携させた自動日記作成ボットです。複数ユーザーが同時にアクセスしても安定して動作するように非同期処理を導入しています。

## 概要

このプロジェクトは、LINEのメッセージングAPIとOpenAI GPTを組み合わせて、ユーザーとの会話を自動的に記録し、日記として保存するシステムです。Google Apps Script（GAS）で実装されており、スプレッドシートをデータベースとして使用しています。

## 主な機能

- LINE Messaging APIを使用したメッセージの送受信
- ChatGPT APIを使用した自然な会話応答の生成
- ユーザー情報の管理とキャッシュ
- 会話ログのスプレッドシート記録
- 複数ユーザーの同時アクセスに対応した非同期処理

## 技術スタック

- Google Apps Script (GAS)
- LINE Messaging API
- OpenAI GPT API
- Google Spreadsheet (データベースとして)

## セットアップ方法

### 前提条件

- Google アカウント
- LINE Developers アカウント
- OpenAI API キー

### 手順

1. Google スプレッドシートを新規作成
2. 以下のシートを作成:
   - プロンプト: ChatGPTへの指示を記述
   - 検証: Webhook確認やエラーログ用
   - ログ: 全ユーザーの会話ログ
   - ユーザー: ユーザー情報管理
   - 情報: 日記データ

3. スクリプトエディタを開き、`コード.js`の内容をコピー

4. スクリプトプロパティに以下を設定:
   - `apikey`: OpenAI APIキー
   - `linetoken`: LINE Messaging APIのアクセストークン

5. デプロイしてWebアプリとして公開

6. LINE DevelopersでWebhook URLを設定

## 非同期処理の実装

複数ユーザーが同時にアクセスしても安定して動作するために、以下の非同期処理を導入しています：

1. **ロック機能**
   - `LockService`を使用して、複数ユーザーが同時にデータを更新する際の競合を防止
   - ユーザー登録、ログ記録、シート更新などの重要な処理にロック機能を実装

2. **キャッシュ機能**
   - `CacheService`を使用して、頻繁にアクセスされるデータをキャッシュ
   - ユーザー情報、シート名、プロフィール情報などをキャッシュして再利用
   - API呼び出しやスプレッドシートへのアクセス回数を削減

3. **即時応答と処理分離**
   - LINEサーバーへの応答を即座に返し、バックグラウンド処理を後で実行
   - ログ記録などの非重要な処理は即時に行うように最適化

4. **バッチ処理の最適化**
   - スプレッドシートへの書き込みを一括で行うように最適化
   - `setValues`メソッドを使用して、複数のセルを一度に更新

5. **エラーハンドリング**
   - 各処理にエラーハンドリングを追加
   - エラー発生時にログを記録する機能を実装

## 使用方法

1. LINEで友達登録すると、ボットが自動的に応答します
2. ユーザーの会話はスプレッドシートに自動的に記録されます
3. 各ユーザーごとに個別のシートが作成され、会話履歴が保存されます
4. スプレッドシートの「カスタムメニュー」から特定のユーザーにメッセージを送信できます

## 注意事項

- OpenAI APIの利用には料金が発生します
- LINE Messaging APIの利用制限に注意してください
- スプレッドシートの容量制限に注意してください

## ライセンス

MIT License
